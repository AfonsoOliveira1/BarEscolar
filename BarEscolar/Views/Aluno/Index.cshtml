@model IEnumerable<BarEscolar.Models.MenuWeek>

@{
    ViewData["Title"] = "Aluno";
    var selectedOption = ViewBag.SelectedOption ?? "A";
}

<h1>Bem-vindo, @ViewBag.User.FullName!</h1>

<a asp-action="Historico" asp-route-id="@ViewBag.User.ID" class="btn btn-primary mb-3">Historico</a>
<a asp-action="MenusMarcados" asp-route-id="@ViewBag.User.ID" class="btn btn-primary mb-3">Menus Marcado</a>
<a asp-action="Bar" asp-route-id="@ViewBag.User.ID" class="btn btn-primary mb-3">Bar da Escola</a>


<h2>Menus da Semana</h2>

<div>
    <div>
        <a asp-action="Index" asp-route-id="@ViewBag.User.ID" asp-route-option="A">Não-Vegan</a>
        <a asp-action="Index" asp-route-id="@ViewBag.User.ID" asp-route-option="B">Vegan</a>
    </div>
</div>

@foreach (var week in Model)
{
    <div class="card mb-4 shadow-sm p-3">
        <h4>Semana começando em: @week.weekstart</h4>
        <table class="table table-striped mt-2">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Prato Principal</th>
                    <th>Sopa</th>
                    <th>Sobremesa</th>
                    <th>Notas</th>
                    <th>Tipo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var menuDay in week.menuDays)
                {
                    <tr>
                        <td>@menuDay.Date.ToShortDateString()</td>
                        <td>@menuDay.MainDish</td>
                        <td>@menuDay.Soup</td>
                        <td>@menuDay.Dessert</td>
                        <td>@menuDay.Notes</td>
                        <td>@(menuDay.option == "A" ? "Não-Vegan" : "Vegan")</td>
                        <td>
                            @{
                                var marked = ((List<int>)ViewBag.MarkedMenuIds).Contains(menuDay.Id);
                                var remaining = menuDay.MaxSeats - (((Dictionary<int, int>)ViewBag.RemainingSeats).GetValueOrDefault(menuDay.Id, 0));
                            }

                            @if (marked)
                            {
                                <button class="btn btn-secondary btn-sm" disabled>Marcado ✓</button>
                            }
                            else
                            {
                                <a asp-action="Marcar"
                                   asp-route-id="@ViewBag.User.ID"
                                   asp-route-menuId="@menuDay.Id"
                                   class="btn btn-success btn-sm">
                                    Marcar (@remaining)
                                </a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
<script>
    const s = document.getElementById("select");

    s.addEventListener("change", function () {

        const option = this.value;
        const userId = "@ViewBag.User.ID";

        console.log("SELECT MUDOU PARA:", option);
        console.log("USER ID:", userId);

        // Testa primeiro no console
        const url = "/Aluno/Index/" + userId + "?option=" + option;
        console.log("URL:", url);

        window.location.href = url;
    });
</script>