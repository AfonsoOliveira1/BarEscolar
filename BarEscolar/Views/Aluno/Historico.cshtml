@model IEnumerable<BarEscolar.Models.OrderItem>

@{
    ViewData["Title"] = "Histórico de Pedidos";
    var allMenus = ViewBag.AllMenus as List<BarEscolar.Models.MenuDay>;
    var allProducts = ViewBag.AllProducts as List<BarEscolar.Models.Product>;
    var allOrders = ViewBag.AllOrders as List<BarEscolar.Models.Order>;
}

<h1>Histórico — @ViewBag.User.FullName</h1>

<a asp-action="Index" asp-route-id="@ViewBag.User.ID" class="btn btn-primary mb-3">
    Voltar aos Menus
</a>

@if (!Model.Any())
{
    <p>Não existem pedidos no histórico.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Data</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Sobremesa</th>
                <th>Sopa</th>
                <th>Preço</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                var order = allOrders.FirstOrDefault(o => o.Id == item.Orderid);
                if (item.IsMenu)
                {
                    var menu = allMenus.FirstOrDefault(m => m.Id == item.Productid);
                    if (menu != null)
                    {
                        <tr>
                            <td>@order?.Createdat.ToShortDateString()</td>
                            <td>@menu.MainDish</td>
                            <td>@(menu.option == "A" ? "Não-Vegan" : "Vegan")</td>
                            <td>@menu.Dessert</td>
                            <td>@menu.Soup</td>
                            <td>@item.Subtotal.ToString("C")</td>
                            <td>
                                @if (item.Quantity == 0)
                                {
                                    <span class="text-danger">Cancelado</span>
                                }
                                else if (menu.Date.Date < DateTime.Today)
                                {
                                    <span class="text-muted">Concluído</span>
                                }
                                else
                                {
                                    <span class="text-success">Marcado</span>
                                }
                            </td>
                        </tr>
                    }
                }
                else // Produto
                {
                    var prod = allProducts.FirstOrDefault(p => p.Id == item.Productid);
                    if (prod != null)
                    {
                        <tr>
                            <td>@order?.Createdat.ToShortDateString()</td>
                            <td>@prod.Name</td>
                            <td>Produto</td>
                            <td>-</td>
                            <td>-</td>
                            <td>@item.Subtotal.ToString("C")</td>
                            <td>
                                @if (item.Quantity == 0)
                                {
                                    <span class="text-danger">Cancelado</span>
                                }
                                else
                                {
                                    <span class="text-success">Comprado</span>
                                }
                            </td>
                        </tr>
                    }
                }
            }
        </tbody>
    </table>
}
