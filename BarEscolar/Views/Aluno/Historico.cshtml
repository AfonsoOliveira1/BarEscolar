@model IEnumerable<BarEscolar.Models.OrderItem>

@{
    ViewData["Title"] = "Histórico de Pedidos";
    var allMenus = ViewBag.AllMenus as List<BarEscolar.Models.MenuDay>;
    var allProducts = ViewBag.AllProducts as List<BarEscolar.Models.Product>;
    var allOrders = ViewBag.AllOrders as List<BarEscolar.Models.Order>;
}

<h1 class="historico-title">Histórico — @ViewBag.User.FullName</h1>



@if (!Model.Any())
{
    <p class="historico-empty">Não existem pedidos no histórico.</p>
}
else
{
    <div class="historico-table-wrapper">
        <table class="table historico-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Sobremesa</th>
                    <th>Sopa</th>
                    <th>Preço</th>
                    <th>Status</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    var order = allOrders.FirstOrDefault(o => o.Id == item.Orderid);
                    if (item.IsMenu)
                    {
                        var menu = allMenus.FirstOrDefault(m => m.Id == item.Productid);
                        if (menu != null)
                        {
                            <tr>
                                <td>@order?.Createdat.ToShortDateString()</td>
                                <td>@menu.MainDish</td>
                                <td>@(menu.option == "A" ? "Não-Vegan" : "Vegan")</td>
                                <td>@menu.Dessert</td>
                                <td>@menu.Soup</td>
                                <td>@item.Subtotal.ToString("C")</td>
                                <td>
                                    @if (item.Quantity == 0)
                                    {
                                        <span class="status-cancelled">Cancelado</span>
                                    }
                                    else if (menu.Date.Date < DateTime.Today)
                                    {
                                        <span class="status-completed">Concluído</span>
                                    }
                                    else
                                    {
                                        <span class="status-marked">Marcado</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        var prod = allProducts.FirstOrDefault(p => p.Id == item.Productid);
                        if (prod != null)
                        {
                            <tr>
                                <td>@order?.Createdat.ToShortDateString()</td>
                                <td>@prod.Name</td>
                                <td>Produto</td>
                                <td>-</td>
                                <td>-</td>
                                <td>@item.Subtotal.ToString("C")</td>
                                <td>
                                    @if (item.Quantity == 0)
                                    {
                                        <span class="status-cancelled">Cancelado</span>
                                    }
                                    else
                                    {
                                        <span class="status-completed">Comprado</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
        <center>
        <a asp-action="Index" asp-route-id="@ViewBag.User.ID" class="btn btn-primary mt-3">
            Voltar aos Menus
        </a>
        </center>
    </div>
}
